# PocketPi 内存符号分析汇总

## 🔍 分析概述

通过分析 `main.map` 文件，我们识别出了 .data 和 .bss 段中的所有符号，并按大小进行了排序。

### 📊 总体统计

| 段类型 | 总大小 (字节) | 总大小 (KB) | 符号数量 |
|--------|--------------|-------------|----------|
| .data  | 13,862       | 13.54       | 85       |
| .bss   | 25,930       | 25.32       | 201      |
| **合计** | **39,792** | **38.86**   | **286**  |

## 🏆 TOP 10 最大内存占用符号

| 排名 | 符号名 | 大小 (字节) | 大小 (KB) | 段类型 | 模块 | 说明 |
|------|--------|-------------|-----------|--------|------|------|
| 1    | `ppu`                   | 7,584 | 7.41 | BSS  | nes_ppu      | NES PPU 视频处理数据 |
| 2    | `drv_epic`              | 3,184 | 3.11 | BSS  | drv_epic     | SiFli EPIC 图形驱动 |
| 3    | `audio_ring_buffer`     | 3,080 | 3.01 | BSS  | audio        | 音频环形缓冲区 |
| 4    | `i2c_obj`               | 1,260 | 1.23 | BSS  | drv_i2c      | I2C 驱动对象 |
| 5    | `info.0`                | 1,025 | 1.00 | BSS  | nes_rom      | NES ROM 信息结构 |
| 6    | `nes`                   | 812   | 0.79 | BSS  | nes          | NES 主控制结构 |
| 7    | `nes_palette`           | 768   | 0.75 | BSS  | nes_pal      | NES 调色板缓存 |
| 8    | `shady_palette`         | 768   | 0.75 | DATA | nes_pal      | NES 调色板数据 |
| 9    | `drv_lcd`               | 612   | 0.60 | BSS  | drv_lcd      | LCD 驱动数据 |
| 10   | `lv_global`             | 520   | 0.51 | BSS  | lv_init      | LVGL 全局数据 |

## 📈 按模块分类的内存占用

| 排名 | 模块类别 | 总大小 (KB) | 主要符号 | 优化潜力 |
|------|----------|-------------|----------|----------|
| 1    | **NES 模拟器**     | 🔴 12.95 | ppu, nes_palette, nes | ⭐⭐⭐⭐⭐ |
| 2    | **图形驱动**       | 🟠 4.22  | drv_epic, drv_lcd, lv_global | ⭐⭐⭐⭐ |
| 3    | **音频系统**       | 🟡 3.01  | audio_ring_buffer | ⭐⭐⭐ |
| 4    | **外设驱动**       | 🟢 2.85  | i2c_obj, uart_obj, spi_bus | ⭐⭐ |
| 5    | **系统/C库**       | 🔵 2.16  | idle, libc symbols | ⭐ |

## 🎯 优化建议及预期收益

### 🔥 高优先级 (预期节省 6-8KB)

1. **NES PPU 优化**
   - 当前: 7.4KB
   - 建议: 使用 PSRAM 或压缩缓冲区
   - 预期节省: 3-4KB

2. **音频缓冲区优化**
   - 当前: 3.0KB  
   - 建议: 减小缓冲区大小或使用外部内存
   - 预期节省: 1-2KB

3. **图形驱动优化**
   - 当前: 3.1KB
   - 建议: 清理未使用的缓冲区
   - 预期节省: 1-2KB

### 🔶 中优先级 (预期节省 1-2KB)

4. **驱动对象结构优化**
   - 检查结构体对齐和填充
   - 按需初始化大对象

5. **NES 映射器优化** 
   - 只编译使用的映射器
   - 使用函数指针替代静态结构

### 🔷 低优先级 (预期节省 <1KB)

6. **系统级优化**
   - 精简 C 库
   - 优化 RTOS 配置

## 📋 实施检查清单

- [ ] 将 PPU 缓冲区移至 PSRAM
- [ ] 评估音频缓冲区大小需求
- [ ] 审查 EPIC 驱动内存使用
- [ ] 优化驱动对象结构体
- [ ] 移除未使用的 NES 映射器
- [ ] 测试内存优化后的功能完整性

## 📁 生成的文件

1. `symbols_analysis.csv` - 详细符号列表 (CSV 格式)
2. `memory_analysis_report.md` - 详细分析报告
3. `analyze_symbols.py` - 分析脚本工具

---
*分析时间: 2025-11-20*  
*分析工具: 自定义 Python 脚本*  
*数据源: main.map (SF32LB52 LCHSPI ULP HCPU)*