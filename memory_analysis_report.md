# 内存符号分析报告

## 概要

通过分析 main.map 文件，发现了 PocketPi 项目中 .data 和 .bss 段的内存使用情况：

- **DATA 段总大小**: 13,862 字节 (13.54 KB)
- **BSS 段总大小**: 25,930 字节 (25.32 KB) 
- **总计**: 39,792 字节 (38.86 KB)

## 最大的内存占用符号分析

### BSS 段 (未初始化数据)

#### 最大的符号:
1. **ppu** (7,584 字节 / 7.41 KB) - NES PPU 相关数据
   - 模块: `nes_ppu.o` 
   - 这是 NES 模拟器的像素处理单元数据，包含视频缓冲区等

2. **drv_epic** (3,184 字节 / 3.11 KB) - EPIC 图形驱动
   - 模块: `drv_epic.o`
   - SiFli 芯片的图形处理驱动相关数据

3. **audio_ring_buffer** (3,080 字节 / 3.01 KB) - 音频环形缓冲区
   - 模块: `audio.o`
   - 用于音频数据的环形缓冲区

4. **i2c_obj** (1,260 字节 / 1.23 KB) - I2C 对象
   - 模块: `drv_i2c.o`
   - I2C 总线驱动相关数据

5. **info.0** (1,025 字节 / 1.00 KB) - ROM 信息
   - 模块: `nes_rom.o`
   - NES ROM 文件信息结构

### DATA 段 (已初始化数据)

#### 最大的符号:
1. **shady_palette** (768 字节 / 0.75 KB) - 调色板数据
   - 模块: `nes_pal.o`
   - NES 调色板数据

2. **pin_irq_hdr_tab** (384 字节 / 0.38 KB) - GPIO 中断处理表
   - 模块: `drv_gpio.o`
   - GPIO 引脚中断处理程序表

3. **__global_locale** (364 字节 / 0.36 KB) - 全局区域设置
   - 模块: `libc.a`
   - C 标准库的区域设置数据

## 按模块分析的最大内存占用

1. **nes_ppu** (7,584 字节) - NES PPU 模拟
2. **drv_epic** (3,188 字节) - 图形驱动  
3. **audio** (3,096 字节) - 音频处理
4. **nes_pal** (1,544 字节) - NES 调色板
5. **drv_i2c** (1,272 字节) - I2C 驱动

## 优化建议

### 高优先级优化 (可节省较多内存)

1. **PPU 缓冲区优化** (可节省 ~3-4KB)
   - 当前 `ppu` 占用 7.4KB，考虑：
   - 使用动态内存分配而非静态数组
   - 优化视频缓冲区大小
   - 使用外部 PSRAM 存储部分缓冲区

2. **音频缓冲区优化** (可节省 ~1-2KB)  
   - `audio_ring_buffer` 占用 3KB
   - 评估是否可以减小缓冲区大小
   - 考虑使用双缓冲而非环形缓冲区

3. **图形驱动优化** (可节省 ~1-2KB)
   - `drv_epic` 占用 3.1KB
   - 检查是否有未使用的缓冲区或数据结构

### 中优先级优化 (可节省少量内存)

4. **NES 映射器优化** (可节省 ~1KB)
   - DATA 段中有大量映射器接口 (每个40字节)
   - 考虑使用函数指针表替代静态结构体数组
   - 只编译实际使用的映射器

5. **驱动对象优化** (可节省 ~500B)
   - `i2c_obj`, `uart_obj`, `spi_bus_obj` 等
   - 检查结构体是否有填充浪费
   - 考虑按需初始化

### 低优先级优化

6. **标准库优化**
   - `__global_locale`, `_impure_data` 等 C 库数据
   - 考虑使用精简版 C 库

## 内存布局建议

1. **使用 PSRAM**: 将大的缓冲区 (如 PPU, 音频) 放入外部 PSRAM
2. **动态分配**: 将一些大的静态数组改为动态分配
3. **分段优化**: 将不常用的数据放到特殊段中，需要时再加载

## 总结

- 前 5 个最大符号占用了约 **18KB** (总量的 45%)
- NES 模拟器相关 (PPU + 调色板) 占用约 **9KB**
- 驱动程序占用约 **8KB** 
- 音频处理占用约 **3KB**

通过优化这些关键模块，预计可以节省 **5-10KB** 的 SRAM 使用量。